generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

model Shop {
  id                    String              @id @default(uuid())
  name                  String              @db.VarChar(200)
  tagline               String?             @db.VarChar(200)
  address               String              @db.Text
  city                  String              @db.VarChar(100)
  state                 String              @db.VarChar(100)
  pincode               String              @db.VarChar(10)
  phone                 String              @db.VarChar(15)
  email                 String              @db.VarChar(255)
  website               String?             @db.VarChar(255)
  gstNumber             String              @db.VarChar(20)
  panNumber             String              @db.VarChar(20)
  logo                  String?             @db.Text
  primaryColor          String?             @db.VarChar(20)
  invoicePrefix         String              @db.VarChar(20)
  bankName              String?             @db.VarChar(200)
  accountNumber         String?             @db.VarChar(50)
  ifscCode              String?             @db.VarChar(20)
  bankBranch            String?             @db.VarChar(200)
  termsAndConditions    String?             @db.Text
  
  // Subscription Management (Simplified)
  subscriptionType      SubscriptionType    @default(TRIAL)
  trialStartDate        DateTime?
  trialEndDate          DateTime?
  lifetimeAmount        Decimal?            @db.Decimal(10, 2) // Discounted amount for lifetime
  lifetimePaidAt        DateTime?
  
  // AMC Management (Mandatory)
  amcRenewalDate        DateTime?
  amcLastRenewalDate    DateTime?
  amcAmount             Decimal             @default(10000.00) @db.Decimal(10, 2)
  
  // User Limits
  maxUsers              Int                 @default(10)
  currentUserCount      Int                 @default(0)
  
  // Activation Status
  isActive              Boolean             @default(true)
  deactivatedAt         DateTime?
  deactivationReason    String?             @db.Text
  
  createdAt             DateTime            @default(now())
  updatedAt             DateTime            @updatedAt
  deletedAt             DateTime?
  
  auditLogs             AuditLog[]
  bisCompliance         BisCompliance[]
  customers             Customer[]
  emiPayments           EmiPayment[]
  products              Product[]
  purchaseOrders        PurchaseOrder[]
  rateMaster            RateMaster[]
  salesOrders           SalesOrder[]
  suppliers             Supplier[]
  transactions          Transaction[]
  users                 User[]

  @@index([isActive])
  @@index([deletedAt])
  @@index([subscriptionType])
  @@index([trialEndDate])
  @@index([amcRenewalDate])
  @@map("shops")
}

model User {
  id        String    @id @default(uuid())
  username  String    @unique @db.VarChar(100)
  password  String    @db.VarChar(255)
  name      String    @db.VarChar(200)
  email     String?   @db.VarChar(255)
  phone     String?   @db.VarChar(15)
  role      UserRole
  shopId    String?
  isActive  Boolean   @default(true)
  lastLogin DateTime?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?
  shop      Shop?     @relation(fields: [shopId], references: [id], onDelete: Cascade)

  @@index([username])
  @@index([shopId])
  @@index([role])
  @@index([isActive])
  @@index([deletedAt])
  @@map("users")
}

model Customer {
  id               String         @id @default(uuid())
  name             String         @db.VarChar(100)
  phone            String         @db.VarChar(10)
  email            String?        @db.VarChar(255)
  whatsapp         String?        @db.VarChar(10)
  address          String?        @db.Text
  city             String?        @db.VarChar(100)
  dateOfBirth      DateTime?      @db.Date
  anniversaryDate  DateTime?      @db.Date
  customerType     CustomerType   @default(RETAIL)
  isActive         Boolean        @default(true)
  registrationDate DateTime       @default(now())
  createdAt        DateTime       @default(now())
  updatedAt        DateTime       @updatedAt
  deletedAt        DateTime?
  shopId           String
  shop             Shop           @relation(fields: [shopId], references: [id], onDelete: Cascade)
  emiPayments      EmiPayment[]
  familyMembers    FamilyMember[]
  salesOrders      SalesOrder[]
  transactions     Transaction[]

  @@index([shopId])
  @@index([phone])
  @@index([customerType])
  @@index([isActive])
  @@index([deletedAt])
  @@map("customers")
}

model FamilyMember {
  id          String    @id @default(uuid())
  customerId  String
  name        String    @db.VarChar(100)
  relation    String    @db.VarChar(50)
  dateOfBirth DateTime? @db.Date
  anniversary DateTime? @db.Date
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  customer    Customer  @relation(fields: [customerId], references: [id], onDelete: Cascade)

  @@index([customerId])
  @@map("family_members")
}

model Supplier {
  id               String          @id @default(uuid())
  name             String          @db.VarChar(200)
  contactPerson    String?         @db.VarChar(100)
  phone            String          @db.VarChar(15)
  email            String?         @db.VarChar(255)
  address          String?         @db.Text
  city             String?         @db.VarChar(100)
  isActive         Boolean         @default(true)
  registrationDate DateTime        @default(now())
  createdAt        DateTime        @default(now())
  updatedAt        DateTime        @updatedAt
  deletedAt        DateTime?
  shopId           String
  products         Product[]
  purchaseOrders   PurchaseOrder[]
  shop             Shop            @relation(fields: [shopId], references: [id], onDelete: Cascade)

  @@index([shopId])
  @@index([isActive])
  @@index([deletedAt])
  @@map("suppliers")
}

model Product {
  id                  String              @id @default(uuid())
  name                String              @db.VarChar(200)
  metalType           MetalType
  purity              String              @db.VarChar(20)
  grossWeight         Decimal             @db.Decimal(10, 3)
  netWeight           Decimal             @db.Decimal(10, 3)
  barcode             String              @db.VarChar(100)
  huid                String?             @db.VarChar(50)
  tagNumber           String?             @db.VarChar(50)
  description         String?             @db.Text
  makingCharges       Decimal             @db.Decimal(10, 2)
  wastagePercent      Decimal             @db.Decimal(5, 2)
  stoneWeight         Decimal?            @db.Decimal(10, 3)
  stoneValue          Decimal?            @db.Decimal(10, 2)
  stoneDescription    String?             @db.Text
  hallmarkNumber      String?             @db.VarChar(50)
  bisCompliant        Boolean             @default(false)
  collectionName      String?             @db.VarChar(100)
  design              String?             @db.VarChar(200)
  size                String?             @db.VarChar(50)
  reorderLevel        Int                 @default(1)
  isActive            Boolean             @default(true)
  isCustomOrder       Boolean             @default(false)
  calculatedPrice     Decimal?            @db.Decimal(12, 2)
  priceOverride       Decimal?            @db.Decimal(12, 2)
  priceOverrideReason String?             @db.Text
  lastPriceUpdate     DateTime?
  rateUsedId          String?
  createdAt           DateTime            @default(now())
  updatedAt           DateTime            @updatedAt
  deletedAt           DateTime?
  supplierId          String?
  shopId              String
  rateUsed            RateMaster?         @relation(fields: [rateUsedId], references: [id])
  shop                Shop                @relation(fields: [shopId], references: [id], onDelete: Cascade)
  supplier            Supplier?           @relation(fields: [supplierId], references: [id])
  purchaseOrderItems  PurchaseOrderItem[]
  stockItems          StockItem[]

  @@unique([shopId, barcode])
  @@index([shopId])
  @@index([metalType])
  @@index([purity])
  @@index([collectionName])
  @@index([barcode])
  @@index([huid])
  @@index([tagNumber])
  @@index([isActive])
  @@index([deletedAt])
  @@index([rateUsedId], map: "products_rateUsedId_fkey")
  @@index([supplierId], map: "products_supplierId_fkey")
  @@index([shopId, isActive, deletedAt], name: "product_active_lookup")
  @@index([shopId, metalType, purity], name: "product_metal_purity")
  @@map("products")
}

model StockItem {
  id               String          @id @default(uuid())
  productId        String
  tagId            String          @unique @db.VarChar(100)
  barcode          String          @unique @db.VarChar(100)
  huid             String?         @db.VarChar(100)
  purchaseCost     Decimal         @db.Decimal(12, 2)
  status           StockStatus     @default(AVAILABLE)
  purchaseOrderId  String?
  purchaseDate     DateTime?
  saleDate         DateTime?
  salesOrderLineId String?         @unique
  createdAt        DateTime        @default(now())
  updatedAt        DateTime        @updatedAt
  deletedAt        DateTime?
  product          Product         @relation(fields: [productId], references: [id])
  purchaseOrder    PurchaseOrder?  @relation(fields: [purchaseOrderId], references: [id])
  salesOrderLine   SalesOrderLine? @relation(fields: [salesOrderLineId], references: [id])

  @@index([productId])
  @@index([status])
  @@index([tagId])
  @@index([barcode])
  @@index([huid])
  @@index([purchaseOrderId])
  @@index([deletedAt])
  @@index([status, deletedAt], name: "stock_status_lookup")
  @@index([productId, status, deletedAt], name: "stock_product_status")
  @@map("stock_items")
}

model RateMaster {
  id                         String     @id @default(uuid())
  metalType                  MetalType
  purity                     String     @db.VarChar(20)
  ratePerGram                Decimal    @db.Decimal(10, 2)
  validUntil                 DateTime?
  rateSource                 RateSource @default(MANUAL)
  isActive                   Boolean    @default(true)
  defaultMakingChargePercent Decimal?   @db.Decimal(5, 2)
  createdBy                  String?    @db.VarChar(100)
  updatedBy                  String?    @db.VarChar(100)
  createdAt                  DateTime   @default(now())
  updatedAt                  DateTime   @updatedAt
  shopId                     String
  products                   Product[]
  shop                       Shop       @relation(fields: [shopId], references: [id], onDelete: Cascade)

  @@index([shopId])
  @@index([metalType, purity, isActive])
  @@index([shopId, metalType, purity, isActive], name: "rate_fast_lookup")
  @@index([shopId, isActive, createdAt], name: "rate_active_recent")
  @@map("rate_master")
}

model PurchaseOrder {
  id                   String              @id @default(uuid())
  orderNumber          String              @db.VarChar(50)
  supplierId           String
  expectedDeliveryDate DateTime?
  actualDeliveryDate   DateTime?
  paymentMethod        PaymentMethod
  discountAmount       Decimal             @default(0.00) @db.Decimal(10, 2)
  totalAmount          Decimal             @db.Decimal(12, 2)
  paidAmount           Decimal             @default(0.00) @db.Decimal(12, 2)
  status               PurchaseOrderStatus @default(PENDING)
  paymentStatus        PaymentStatus       @default(PENDING)
  referenceNumber      String?             @db.VarChar(100)
  notes                String?             @db.Text
  orderDate            DateTime            @default(now())
  createdAt            DateTime            @default(now())
  updatedAt            DateTime            @updatedAt
  deletedAt            DateTime?
  shopId               String
  items                PurchaseOrderItem[]
  shop                 Shop                @relation(fields: [shopId], references: [id], onDelete: Cascade)
  supplier             Supplier            @relation(fields: [supplierId], references: [id])
  payments             PurchasePayment[]
  stockItems           StockItem[]

  @@unique([shopId, orderNumber])
  @@index([shopId])
  @@index([supplierId])
  @@index([orderNumber])
  @@index([status])
  @@index([orderDate])
  @@index([deletedAt])
  @@map("purchase_orders")
}

model PurchaseOrderItem {
  id               String        @id @default(uuid())
  purchaseOrderId  String
  productId        String
  quantity         Int
  unitPrice        Decimal       @db.Decimal(10, 2)
  expectedWeight   Decimal?      @db.Decimal(10, 3)
  receivedQuantity Int           @default(0)
  createdAt        DateTime      @default(now())
  updatedAt        DateTime      @updatedAt
  product          Product       @relation(fields: [productId], references: [id])
  purchaseOrder    PurchaseOrder @relation(fields: [purchaseOrderId], references: [id], onDelete: Cascade)

  @@index([purchaseOrderId])
  @@index([productId])
  @@map("purchase_order_items")
}

model PurchasePayment {
  id              String        @id @default(uuid())
  purchaseOrderId String
  amount          Decimal       @db.Decimal(12, 2)
  paymentDate     DateTime      @default(now())
  paymentMethod   PaymentMethod
  referenceNumber String?       @db.VarChar(100)
  notes           String?       @db.Text
  createdAt       DateTime      @default(now())
  purchaseOrder   PurchaseOrder @relation(fields: [purchaseOrderId], references: [id], onDelete: Cascade)

  @@index([purchaseOrderId])
  @@index([paymentDate])
  @@map("purchase_payments")
}

model SalesOrder {
  id             String           @id @default(uuid())
  invoiceNumber  String           @db.VarChar(50)
  customerId     String
  orderTotal     Decimal          @db.Decimal(12, 2)
  discountAmount Decimal          @default(0.00) @db.Decimal(10, 2)
  finalAmount    Decimal          @db.Decimal(12, 2)
  paidAmount     Decimal          @default(0.00) @db.Decimal(12, 2)
  paymentMethod  PaymentMethod
  orderType      OrderType        @default(RETAIL)
  status         SalesOrderStatus @default(PENDING)
  paymentStatus  PaymentStatus    @default(PENDING)
  notes          String?          @db.Text
  orderDate      DateTime         @default(now())
  createdAt      DateTime         @default(now())
  updatedAt      DateTime         @updatedAt
  deletedAt      DateTime?
  shopId         String
  lines          SalesOrderLine[]
  customer       Customer         @relation(fields: [customerId], references: [id])
  shop           Shop             @relation(fields: [shopId], references: [id], onDelete: Cascade)
  payments       SalesPayment[]
  transactions   Transaction[]

  @@unique([shopId, invoiceNumber])
  @@index([shopId])
  @@index([customerId])
  @@index([invoiceNumber])
  @@index([status])
  @@index([orderDate])
  @@index([deletedAt])
  @@index([shopId, status, deletedAt], name: "sales_shop_status")
  @@index([shopId, orderDate, deletedAt], name: "sales_date_range")
  @@index([customerId, orderDate], name: "sales_customer_date")
  @@map("sales_orders")
}

model SalesOrderLine {
  id           String     @id @default(uuid())
  salesOrderId String
  stockItemId  String     @unique
  quantity     Int        @default(1)
  unitPrice    Decimal    @db.Decimal(12, 2)
  lineTotal    Decimal    @db.Decimal(12, 2)
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt
  salesOrder   SalesOrder @relation(fields: [salesOrderId], references: [id], onDelete: Cascade)
  stockItem    StockItem?

  @@index([salesOrderId])
  @@index([stockItemId])
  @@map("sales_order_lines")
}

model SalesPayment {
  id              String        @id @default(uuid())
  salesOrderId    String
  amount          Decimal       @db.Decimal(12, 2)
  paymentDate     DateTime      @default(now())
  paymentMethod   PaymentMethod
  referenceNumber String?       @db.VarChar(100)
  notes           String?       @db.Text
  createdAt       DateTime      @default(now())
  salesOrder      SalesOrder    @relation(fields: [salesOrderId], references: [id], onDelete: Cascade)

  @@index([salesOrderId])
  @@index([paymentDate])
  @@map("sales_payments")
}

model Transaction {
  id               String              @id @default(uuid())
  transactionDate  DateTime            @default(now())
  transactionType  TransactionType
  amount           Decimal             @db.Decimal(12, 2)
  paymentMode      PaymentMethod
  category         TransactionCategory @default(OTHER)
  description      String?             @db.Text
  referenceNumber  String?             @db.VarChar(100)
  customerId       String?
  salesOrderId     String?
  status           TransactionStatus   @default(COMPLETED)
  currency         String              @default("INR") @db.VarChar(3)
  metalType        MetalType?
  metalPurity      String?             @db.VarChar(20)
  metalWeight      Decimal?            @db.Decimal(10, 3)
  metalRatePerGram Decimal?            @db.Decimal(10, 2)
  metalCost        Decimal?            @db.Decimal(12, 2)
  createdBy        String?             @db.VarChar(100)
  createdAt        DateTime            @default(now())
  updatedAt        DateTime            @updatedAt
  deletedAt        DateTime?
  shopId           String
  customer         Customer?           @relation(fields: [customerId], references: [id])
  salesOrder       SalesOrder?         @relation(fields: [salesOrderId], references: [id])
  shop             Shop                @relation(fields: [shopId], references: [id], onDelete: Cascade)

  @@index([shopId])
  @@index([transactionDate])
  @@index([transactionType])
  @@index([customerId])
  @@index([salesOrderId])
  @@index([status])
  @@index([deletedAt])
  @@map("transactions")
}

model EmiPayment {
  id                   String               @id @default(uuid())
  customerId           String
  salesOrderId         String?
  totalAmount          Decimal              @db.Decimal(12, 2)
  interestRate         Decimal              @default(0.00) @db.Decimal(5, 2)
  numberOfInstallments Int
  installmentAmount    Decimal              @db.Decimal(10, 2)
  emiStartDate         DateTime
  lastPaymentDate      DateTime?
  nextInstallmentDate  DateTime
  remainingAmount      Decimal              @db.Decimal(12, 2)
  currentInstallment   Int                  @default(1)
  status               EmiInstallmentStatus @default(PENDING)
  createdAt            DateTime             @default(now())
  updatedAt            DateTime             @updatedAt
  deletedAt            DateTime?
  shopId               String
  installments         EmiInstallment[]
  customer             Customer             @relation(fields: [customerId], references: [id])
  shop                 Shop                 @relation(fields: [shopId], references: [id], onDelete: Cascade)

  @@index([shopId])
  @@index([customerId])
  @@index([nextInstallmentDate])
  @@index([status])
  @@index([deletedAt])
  @@map("emi_payments")
}

model EmiInstallment {
  id                String               @id @default(uuid())
  emiPaymentId      String
  installmentNumber Int
  dueDate           DateTime
  amount            Decimal              @db.Decimal(10, 2)
  paidAmount        Decimal              @default(0.00) @db.Decimal(10, 2)
  paymentDate       DateTime?
  paymentMode       PaymentMethod?
  referenceNumber   String?              @db.VarChar(100)
  status            EmiInstallmentStatus @default(PENDING)
  createdAt         DateTime             @default(now())
  updatedAt         DateTime             @updatedAt
  emiPayment        EmiPayment           @relation(fields: [emiPaymentId], references: [id], onDelete: Cascade)

  @@index([emiPaymentId])
  @@index([dueDate])
  @@index([status])
  @@map("emi_installments")
}

model AuditLog {
  id           String        @id @default(uuid())
  timestamp    DateTime      @default(now())
  userId       String?       @db.VarChar(100)
  action       AuditAction
  module       AuditModule
  entityId     String?       @db.VarChar(100)
  beforeData   String?       @db.LongText
  afterData    String?       @db.LongText
  severity     AuditSeverity @default(INFO)
  ipAddress    String?       @db.VarChar(45)
  userAgent    String?       @db.Text
  errorMessage String?       @db.Text
  stackTrace   String?       @db.Text
  shopId       String
  shop         Shop          @relation(fields: [shopId], references: [id], onDelete: Cascade)

  @@index([shopId])
  @@index([timestamp])
  @@index([userId])
  @@index([module])
  @@index([action])
  @@map("audit_logs")
}

model BisCompliance {
  id                   String              @id @default(uuid())
  productId            String?
  stockItemId          String?
  huid                 String              @db.VarChar(50)
  huidRegistrationDate DateTime?
  hallmarkNumber       String?             @db.VarChar(50)
  complianceStatus     BisComplianceStatus @default(PENDING)
  bisStandard          String?             @db.VarChar(20)
  ahcCode              String?             @db.VarChar(50)
  jewelType            String?             @db.VarChar(100)
  certificationDate    DateTime?
  expiryDate           DateTime?
  notes                String?             @db.Text
  createdAt            DateTime            @default(now())
  updatedAt            DateTime            @updatedAt
  shopId               String
  shop                 Shop                @relation(fields: [shopId], references: [id], onDelete: Cascade)

  @@unique([shopId, huid])
  @@index([shopId])
  @@index([huid])
  @@index([complianceStatus])
  @@map("bis_compliance")
}

enum UserRole {
  SUPER_ADMIN
  OWNER
  SALES
  ACCOUNTS
}

enum CustomerType {
  RETAIL
  WHOLESALE
  VIP
}

enum MetalType {
  GOLD
  SILVER
  PLATINUM
}

enum StockStatus {
  AVAILABLE
  RESERVED
  SOLD
}

enum RateSource {
  MARKET
  MANUAL
  API
}

enum PurchaseOrderStatus {
  PENDING
  CONFIRMED
  PARTIAL
  DELIVERED
  CANCELLED
  CLOSED
}

enum PaymentStatus {
  PENDING
  PARTIAL
  PAID
}

enum PaymentMethod {
  CASH
  UPI
  CARD
  BANK_TRANSFER
  CREDIT
  EMI
}

enum SalesOrderStatus {
  PENDING
  COMPLETED
  CANCELLED
}

enum OrderType {
  RETAIL
  WHOLESALE
  CUSTOM
  EXCHANGE
}

enum TransactionType {
  INCOME
  EXPENSE
  EMI
  METAL_PURCHASE
  GOLD_SCHEME
  ADJUSTMENT
}

enum TransactionCategory {
  SALES
  PURCHASE
  OPERATIONAL
  OTHER_EXPENSES
  OTHER
}

enum TransactionStatus {
  COMPLETED
  PENDING
  FAILED
}

enum EmiInstallmentStatus {
  PENDING
  PAID
  OVERDUE
}

enum AuditAction {
  CREATE
  UPDATE
  DELETE
  STATUS_CHANGE
}

enum AuditModule {
  CUSTOMERS
  PRODUCTS
  STOCK
  SUPPLIERS
  PURCHASE_ORDERS
  SALES_ORDERS
  TRANSACTIONS
  EMI
  RATE_MASTER
}

enum AuditSeverity {
  INFO
  WARNING
  ERROR
}

enum BisComplianceStatus {
  COMPLIANT
  NON_COMPLIANT
  PENDING
}

enum SubscriptionType {
  TRIAL
  LIFETIME
}
